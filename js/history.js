// map-data/js/history.js
// 2026-01-01 最终精确修正版：
// 1. 宋代/清代：【安仁】、【炎陵(酃县)】归属【衡州/衡州府】。（修正了之前误划给郴州或长沙的错误）
// 2. 宋代/清代：保留【茶陵、攸县】归属【长沙(潭州)】。
// 3. 彻底厘清了湘东地区古代的府界：北属长沙，南属衡州。

const HistoryModule = {
    eras: [
        // ============================================================
        // Index 0: 秦汉 (保持不变)
        // ============================================================
        {
            year: "秦汉 (前221-220)",
            title: "长沙郡 & 零陵郡",
            desc: "秦设长沙郡。茶陵/攸县/南县等均属长沙郡管辖。",
            provinceGroups: [
                {
                    name: "黔中/武陵郡",
                    color: "#5b8c00",
                    members: [
                        "常德", "武陵", "鼎城", "桃源", "汉寿", "石门", "澧县", "临澧", "安乡", "津市", 
                        "张家界", "永定", "武陵源", "慈利", "桑植", 
                        "湘西", "吉首", "凤凰", "花垣", "保靖", "古丈", "永顺", "龙山", "泸溪", 
                        "怀化", "鹤城", "洪江", "中方", "沅陵", "辰溪", "溆浦", "会同", "麻阳", "新晃", "芷江", "靖州", "通道"
                    ]
                },
                {
                    name: "长沙郡",
                    color: "#d4b16e",
                    members: [
                        "长沙", "芙蓉", "天心", "岳麓", "开福", "雨花", "望城", "宁乡", "浏阳", 
                        "湘潭", "雨湖", "岳塘", "湘乡", "韶山", 
                        "株洲", "天元", "芦淞", "荷塘", "石峰", "渌口", "醴陵", 
                        "攸县", "茶陵", "炎陵", "酃县", // 秦汉时期多属长沙郡辖域
                        "益阳", "赫山", "资阳", "桃江", "安化", "沅江", "南县", 
                        "娄底", "娄星", "双峰", "涟源", 
                        "衡阳", "衡阳县", "珠晖", "雁峰", "石鼓", "蒸湘", "衡山", "衡东", "耒阳", "南岳", "衡南", "常宁",
                        "安仁" // 秦汉属长沙郡辖域
                    ]
                },
                {
                    name: "零陵郡",
                    color: "#8c8c8c",
                    members: [
                        "永州", "零陵", "冷水滩", "东安", "道县", "宁远", "江永", "江华", "蓝山", "新田", "双牌", 
                        "祁阳", "祁东", 
                        "邵阳", "大祥", "双清", "北塔", "新邵", "邵东", "隆回", "武冈", "城步", "新宁", "绥宁", "洞口", 
                        "新化", "冷水江"
                    ]
                },
                { name: "桂阳郡", color: "#eb2f96", members: ["郴州", "北湖", "苏仙", "桂阳", "宜章", "永兴", "嘉禾", "临武", "汝城", "桂东", "安仁", "资兴"] },
                { name: "罗县/古岳州", color: "#faad14", members: ["岳阳", "岳阳楼", "云溪", "君山", "平江", "临湘", "华容", "湘阴", "汨罗"] }
            ],
            center: [28.2, 112.9], zoom: 7
        },

        // ============================================================
        // Index 1: 宋代 (修正安仁、炎陵归属)
        // ============================================================
        {
            year: "宋代 (960-1279)",
            title: "荆湖南路",
            desc: "茶陵/攸县属潭州；酃县(炎陵)/安仁属衡州。",
            provinceGroups: [
                // 1. 潭州：只包含茶陵、攸县，【不含炎陵】
                { 
                    name: "潭州", 
                    color: "#d4b16e", 
                    members: [
                        "长沙", "芙蓉", "天心", "岳麓", "开福", "雨花", "望城", "宁乡", "浏阳", 
                        "湘潭", "雨湖", "岳塘", "湘乡", "韶山", 
                        "株洲", "天元", "芦淞", "荷塘", "石峰", "渌口", "醴陵", 
                        "攸县", "茶陵", // 潭州南界
                        "娄底", "娄星", "双峰", "涟源"
                    ] 
                },
                
                // 2. 衡州：【加入安仁、炎陵、酃县】
                // 且优先级高，防止被郴州或岳州抢走
                { 
                    name: "衡州", 
                    color: "#f5222d", 
                    members: [
                        "衡阳", "衡南", "珠晖", "雁峰", "石鼓", "蒸湘", "衡山", "衡东", "耒阳", "常宁", "祁东", "南岳",
                        "安仁",           // 【修正】宋代属衡州
                        "炎陵", "酃县"    // 【修正】宋代属衡州
                    ] 
                },

                { name: "邵州(宝庆)", color: "#722ed1", members: ["邵阳", "大祥", "双清", "北塔", "新邵", "邵东", "隆回", "武冈", "新宁", "城步", "新化", "冷水江", "绥宁", "洞口"] },
                
                { name: "澧州", color: "#87d068", members: ["澧县", "石门", "临澧", "慈利", "津市", "安乡", "武陵源", "永定", "张家界", "桑植"] },
                { name: "鼎州", color: "#5b8c00", members: ["常德", "武陵", "鼎城", "桃源", "汉寿", "沅江"] },
                
                { name: "岳州", color: "#faad14", members: ["岳阳", "岳阳楼", "云溪", "君山", "平江", "临湘", "华容", "湘阴", "汨罗", "南县"] },
                
                { name: "永州", color: "#2f54eb", members: ["永州", "零陵", "冷水滩", "祁阳", "东安", "双牌", "道县", "宁远", "江永", "江华", "蓝山", "新田"] },
                { name: "益阳", color: "#84cc16", members: ["益阳", "赫山", "资阳", "桃江", "安化"] },
                
                // 郴州：移除安仁
                { name: "郴州", color: "#eb2f96", members: ["郴州", "北湖", "苏仙", "桂阳", "宜章", "永兴", "嘉禾", "临武", "汝城", "桂东", "资兴"] },
                
                { name: "羁縻州/其他", color: "#13c2c2", members: ["怀化", "鹤城", "洪江", "中方", "沅陵", "辰溪", "溆浦", "会同", "麻阳", "新晃", "芷江", "靖州", "通道", "湘西", "吉首", "凤凰", "花垣", "保靖", "古丈", "永顺", "龙山", "泸溪"] }
            ],
            center: [28.2, 112.9], zoom: 7
        },

        // ============================================================
        // Index 2: 清代 (修正安仁、炎陵归属)
        // ============================================================
        {
            year: "清 (1644-1911)",
            title: "湖南省",
            desc: "茶陵/攸县属长沙府；酃县/安仁属衡州府。",
            provinceGroups: [
                // 1. 长沙府：【不含炎陵/酃县】
                { 
                    name: "长沙府", 
                    color: "#d4b16e", 
                    members: [
                        "长沙", "芙蓉", "天心", "岳麓", "开福", "雨花", "望城", "宁乡", "浏阳", 
                        "湘潭", "雨湖", "岳塘", "湘乡", "韶山", 
                        "株洲", "天元", "芦淞", "荷塘", "石峰", "渌口", "醴陵", 
                        "攸县", "茶陵", // 长沙府十二属之二
                        "益阳", "赫山", "资阳", "桃江", "安化", 
                        "娄底", "娄星", "双峰", "涟源"
                    ] 
                },
                
                // 2. 衡州府：【加入安仁、炎陵】
                { 
                    name: "衡州府", 
                    color: "#f5222d", 
                    members: [
                        "衡阳", "衡南", "珠晖", "雁峰", "石鼓", "蒸湘", "衡山", "衡东", "祁东", "耒阳", "常宁", "南岳",
                        "安仁",           // 【修正】清代属衡州府
                        "炎陵", "酃县"    // 【修正】清代属衡州府
                    ] 
                },

                { name: "宝庆府", color: "#722ed1", members: ["邵阳", "大祥", "双清", "北塔", "新邵", "邵东", "隆回", "武冈", "城步", "新宁", "绥宁", "洞口", "新化", "冷水江"] },
                
                { name: "澧州直隶州", color: "#87d068", members: ["澧县", "石门", "临澧", "慈利", "安乡", "津市", "张家界", "永定", "武陵源", "桑植"] },
                { name: "常德府", color: "#5b8c00", members: ["常德", "武陵", "鼎城", "桃源", "汉寿", "沅江", "南县"] },
                { name: "岳州府", color: "#faad14", members: ["岳阳", "岳阳楼", "云溪", "君山", "平江", "华容", "临湘", "湘阴", "汨罗"] },
                { name: "永州府", color: "#2f54eb", members: ["永州", "零陵", "冷水滩", "祁阳", "东安", "双牌", "道县", "宁远", "江永", "江华", "蓝山", "新田"] },
                
                // 郴州：移除安仁
                { name: "郴州直隶州", color: "#eb2f96", members: ["郴州", "北湖", "苏仙", "桂阳", "宜章", "永兴", "嘉禾", "临武", "汝城", "桂东", "资兴"] },
                
                { name: "辰沅永靖", color: "#13c2c2", members: ["怀化", "鹤城", "洪江", "中方", "沅陵", "辰溪", "溆浦", "会同", "麻阳", "新晃", "芷江", "靖州", "通道", "湘西", "吉首", "凤凰", "花垣", "保靖", "古丈", "永顺", "龙山", "泸溪"] }
            ],
            center: [28.2, 112.9], zoom: 7
        },

        // ============================================================
        // Index 3: 1969年 (保持不变)
        // ============================================================
        {
            year: "1969 (地区改制)",
            title: "韶山/株洲/长沙省辖",
            desc: "长沙市省辖。宁乡属益阳。茶陵/攸县属湘潭地区。",
            provinceGroups: [
                { name: "韶山区(地级)", color: "#ff0000", members: ["韶山"] },
                { name: "株洲市(省辖)", color: "#2563eb", members: ["株洲市", "天元", "芦淞", "荷塘", "石峰", "株洲县", "渌口"] },
                { name: "长沙市(省辖)", color: "#ef4444", members: ["长沙市", "芙蓉", "天心", "岳麓", "开福", "雨花", "长沙县", "望城"] },
                { name: "湘潭地区", color: "#d97706", members: ["湘潭", "雨湖", "岳塘", "湘乡", "浏阳", "醴陵", "攸县", "茶陵", "炎陵", "酃县"] },
                { name: "邵阳地区", color: "#06b6d4", members: ["邵阳", "大祥", "双清", "北塔", "新邵", "邵东", "隆回", "洞口", "武冈", "绥宁", "新宁", "城步", "娄底", "娄星", "新化", "冷水江", "涟源", "双峰"] },
                { name: "衡阳地区", color: "#8b5cf6", members: ["衡阳", "衡南", "珠晖", "雁峰", "石鼓", "蒸湘", "南岳", "衡山", "衡东", "常宁", "耒阳", "祁东", "安仁"] }, // 安仁此时属衡阳
                { name: "湘西州", color: "#a855f7", members: ["湘西", "吉首", "泸溪", "凤凰", "花垣", "保靖", "古丈", "永顺", "龙山", "张家界", "大庸", "永定", "武陵源", "桑植"] },
                { name: "常德地区", color: "#f472b6", members: ["常德", "武陵", "鼎城", "桃源", "汉寿", "安乡", "澧县", "临澧", "津市", "石门", "慈利"] },
                { name: "益阳地区", color: "#84cc16", members: ["益阳", "赫山", "资阳", "沅江", "南县", "桃江", "安化", "宁乡"] },
                { name: "岳阳地区", color: "#10b981", members: ["岳阳", "岳阳楼", "云溪", "君山", "平江", "湘阴", "汨罗", "临湘", "华容"] },
                { name: "零陵地区", color: "#2f54eb", members: ["永州", "零陵", "冷水滩", "祁阳", "东安", "双牌", "道县", "江永", "宁远", "蓝山", "新田", "江华"] },
                { name: "郴州地区", color: "#6366f1", members: ["郴州", "北湖", "苏仙", "资兴", "桂阳", "宜章", "永兴", "嘉禾", "临武", "汝城", "桂东"] },
                { name: "黔阳地区", color: "#f59e0b", members: ["怀化", "鹤城", "中方", "沅陵", "辰溪", "溆浦", "会同", "麻阳", "新晃", "芷江", "靖州", "通道", "洪江"] }
            ],
            center: [27.7, 111.8], zoom: 7
        },

        // ============================================================
        // Index 4: 1977年 (保持不变)
        // ============================================================
        {
            year: "1977 (涟源地区成立)",
            title: "涟源地区设立 & 邵阳升格",
            desc: "涟源地区成立。邵阳市升格。宁乡属益阳。茶陵/攸县属湘潭。",
            provinceGroups: [
                { name: "长沙市(省辖)", color: "#ef4444", members: ["长沙", "芙蓉", "天心", "岳麓", "开福", "雨花", "长沙县", "望城"] },
                { name: "株洲市(省辖)", color: "#2563eb", members: ["株洲", "天元", "芦淞", "荷塘", "石峰", "株洲县", "渌口"] },
                { name: "邵阳市(省辖)", color: "#ea580c", members: ["邵阳市", "大祥", "双清", "北塔"] },
                { name: "湘潭地区", color: "#d97706", members: ["湘潭", "雨湖", "岳塘", "湘乡", "韶山", "浏阳", "醴陵", "攸县", "茶陵", "炎陵"] },
                { name: "涟源地区", color: "#d946ef", members: ["娄底", "娄星", "涟源", "双峰", "新化", "冷水江", "邵东", "新邵"] },
                { name: "邵阳地区", color: "#06b6d4", members: ["邵阳县", "隆回", "洞口", "武冈", "绥宁", "新宁", "城步"] },
                { name: "衡阳地区", color: "#8b5cf6", members: ["衡阳", "衡南", "珠晖", "雁峰", "石鼓", "蒸湘", "衡山", "衡东", "南岳", "耒阳", "常宁", "祁东", "安仁"] },
                { name: "益阳地区", color: "#84cc16", members: ["益阳", "赫山", "资阳", "安化", "桃江", "南县", "沅江", "宁乡"] },
                { name: "湘西州", color: "#a855f7", members: ["湘西", "大庸", "永定", "武陵源", "桑植", "吉首", "凤凰", "泸溪", "花垣", "保靖", "古丈", "永顺", "龙山"] },
                { name: "常德地区", color: "#f472b6", members: ["常德", "武陵", "鼎城", "慈利", "石门", "澧县", "临澧", "安乡", "汉寿", "桃源", "津市"] },
                { name: "岳阳地区", color: "#10b981", members: ["岳阳", "岳阳楼", "云溪", "君山", "华容", "平江", "湘阴", "汨罗", "临湘"] },
                { name: "零陵地区", color: "#2f54eb", members: ["永州", "零陵", "冷水滩", "祁阳", "东安", "道县", "江华", "江永", "宁远", "蓝山", "新田", "双牌"] },
                { name: "郴州地区", color: "#6366f1", members: ["郴州", "北湖", "苏仙", "资兴", "永兴", "宜章", "桂阳", "嘉禾", "临武", "汝城", "桂东"] },
                { name: "黔阳地区", color: "#f59e0b", members: ["怀化", "鹤城", "芷江", "沅陵", "洪江", "中方", "辰溪", "溆浦", "会同", "麻阳", "新晃", "靖州", "通道"] }
            ],
            center: [27.7, 111.8], zoom: 7
        },

        // ============================================================
        // Index 5: 现代 (保持不变)
        // ============================================================
        {
            year: "现代 (1999-今)",
            title: "湖南省行政区划",
            desc: "现行13市1州格局。茶陵/攸县/炎陵归株洲。",
            provinceGroups: [
                { name: "长沙", color: "#ef4444", members: ["长沙", "芙蓉", "天心", "岳麓", "开福", "雨花", "望城", "长沙县", "浏阳", "宁乡"] },
                { name: "株洲", color: "#3b82f6", members: ["株洲", "天元", "芦淞", "荷塘", "石峰", "渌口", "醴陵", "攸县", "茶陵", "炎陵"] },
                { name: "湘潭", color: "#0891b2", members: ["湘潭", "雨湖", "岳塘", "湘乡", "韶山", "湘潭县"] },
                { name: "衡阳", color: "#8b5cf6", members: ["衡阳", "珠晖", "雁峰", "石鼓", "蒸湘", "南岳", "耒阳", "常宁", "衡山", "衡东", "祁东", "衡南"] },
                { name: "邵阳", color: "#06b6d4", members: ["邵阳", "大祥", "双清", "北塔", "武冈", "邵东", "新宁", "隆回", "洞口", "绥宁", "城步", "新邵"] },
                { name: "岳阳", color: "#10b981", members: ["岳阳", "岳阳楼", "云溪", "君山", "汨罗", "临湘", "平江", "湘阴", "华容"] },
                { name: "张家界", color: "#0d9488", members: ["张家界", "永定", "武陵源", "慈利", "桑植"] },
                { name: "常德", color: "#f472b6", members: ["常德", "武陵", "鼎城", "津市", "石门", "澧县", "桃源", "汉寿", "临澧", "安乡"] },
                { name: "益阳", color: "#84cc16", members: ["益阳", "赫山", "资阳", "沅江", "桃江", "安化", "南县"] },
                { name: "郴州", color: "#6366f1", members: ["郴州", "北湖", "苏仙", "资兴", "桂阳", "宜章", "永兴", "嘉禾", "临武", "汝城", "桂东", "安仁"] },
                { name: "永州", color: "#2f54eb", members: ["永州", "零陵", "冷水滩", "祁阳", "东安", "道县", "江永", "宁远", "蓝山", "新田", "江华", "双牌"] },
                { name: "怀化", color: "#f59e0b", members: ["怀化", "鹤城", "中方", "洪江", "沅陵", "溆浦", "辰溪", "会同", "麻阳", "新晃", "芷江", "靖州", "通道"] },
                { name: "娄底", color: "#d946ef", members: ["娄底", "娄星", "冷水江", "涟源", "双峰", "新化"] },
                { name: "湘西", color: "#a855f7", members: ["湘西", "吉首", "凤凰", "古丈", "泸溪", "花垣", "保靖", "永顺", "龙山"] }
            ],
            center: [27.5, 111.8], zoom: 7
        }
    ],

    render: function(map, geoData, index, isProvinceMode) {
        if (index < 0 || index >= this.eras.length) return null;
        const era = this.eras[index];

        const t = document.getElementById("h-title");
        if(t) {
            document.getElementById("h-title").innerText = era.title;
            document.getElementById("h-era").innerText = era.year;
            document.getElementById("h-desc").innerText = era.desc;
        }

        const groups = isProvinceMode ? (era.provinceGroups || []) : (era.groups || []);

        return L.geoJSON(geoData, {
            style: function(feature) {
                const name = feature.properties.name || "";
                let fillColor = "#eee"; 
                let fillOpacity = 0.1;

                for (let g of groups) {
                    if (g.members.some(m => name.includes(m))) {
                        fillColor = g.color;
                        fillOpacity = 0.6;
                        break;
                    }
                }

                return {
                    color: "#fff",
                    weight: 0.5,
                    fillColor: fillColor,
                    fillOpacity: fillOpacity
                };
            },
            onEachFeature: function(feature, layer) {
                const name = feature.properties.name || "";
                let belongTo = "未分类";
                for (let g of groups) {
                    if (g.members.some(m => name.includes(m))) {
                        belongTo = g.name || era.title;
                        break;
                    }
                }
                
                layer.bindPopup(`
                    <div style="text-align:center; padding:5px;">
                        <h3 style="margin:0 0 5px 0;">${name}</h3>
                        <div style="font-size:12px; color:#666;">${era.year}</div>
                        <div style="margin-top:5px;">归属：<b>${belongTo}</b></div>
                    </div>
                `);
            }
        });
    }
};